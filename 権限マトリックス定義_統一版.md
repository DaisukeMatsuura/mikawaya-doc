# まごころサポート システム - 権限マトリックス統一版

**ドキュメント作成日**: 2026-01-09
**ステータス**: 最終版（全画面に適用）

---

## 1. ユーザー種別の定義

| ユーザー種別 | 説明 |
| --- | --- |
| **管理者** | システム全体の管理者。全機能へのアクセス権限を持つ。 |
| **オペレータ** | サポート運用者。全顧客・全案件の管理が可能。 |
| **パートナー加盟店** | 加盟店の担当者。自店舗関連の顧客・案件のみ管理可能。 |
| **コンシェルジュ** | 現場対応者。自分が担当する案件のみ管理可能。スマホ対応。 |

---

## 2. 権限マトリックス（全機能共通）

### 権限レベルの定義

| 記号 | 意味 | 説明 |
| --- | --- | --- |
| **◯** | アクセス可能 | 該当機能へのアクセスと操作が可能 |
| **△** | 限定アクセス | 自分に関連するデータのみアクセス可能 |
| **✕** | アクセス不可 | 該当機能へのアクセスが禁止 |
| **—** | 対象外 | そのユーザーには該当しない機能 |

---

## 3. 画面別権限一覧

### 認証画面

#### ログイン画面
| ユーザー種別 | 権限 |
| --- | --- |
| 未ログイン | ◯ |
| ログイン済み | ダッシュボードへリダイレクト |

#### パスワード再設定
| ユーザー種別 | 権限 |
| --- | --- |
| 未ログイン | ◯ |
| ログイン済み | — |

---

### ダッシュボード

| ユーザー種別 | 閲覧 |
| --- | --- |
| 管理者 | ◯（全体統計）|
| オペレータ | ◯（未決定・未対応案件）|
| パートナー | ◯（自店舗案件）|
| コンシェルジュ | ◯（自分の案件）|

**デバイス対応**:
- コンシェルジュ：スマホ専用
- その他：PC/レスポンシブ

---

### 顧客管理画面

#### お客様一覧
| ユーザー種別 | 閲覧 | 作成 | 編集 |
| --- | --- | --- | --- |
| 管理者 | ◯（全件） | ◯ | ◯ |
| オペレータ | ◯（全件） | ◯ | ◯ |
| パートナー | △（自店舗のみ） | ◯ | ◯ |
| コンシェルジュ | △（自店舗のみ） | ◯ | △ |

**注**: コンシェルジュは案件を通じて自動的に関連顧客にアクセス

#### お客様詳細
| ユーザー種別 | 閲覧 | 編集 |
| --- | --- | --- |
| 管理者 | ◯（全件） | ◯ |
| オペレータ | ◯（全件） | ◯ |
| パートナー | △（自店舗のみ） | ◯ |
| コンシェルジュ | △（自店舗のみ） | △ |

#### お客様作成・編集
| ユーザー種別 | 実行 |
| --- | --- |
| 管理者 | ◯ |
| オペレータ | ◯ |
| パートナー | ◯ |
| コンシェルジュ | ◯ |

---

### 案件管理画面

#### 案件一覧
| ユーザー種別 | 閲覧 | 作成 | 編集 |
| --- | --- | --- | --- |
| 管理者 | ◯（全件） | ◯ | ◯ |
| オペレータ | ◯（全件） | ◯ | ◯ |
| パートナー | △（自店舗のみ） | ◯ | ◯ |
| コンシェルジュ | △（自分の案件のみ） | ◯ | ◯ |

**注**: コンシェルジュはスマホ専用版で簡略表示

#### 案件詳細
| ユーザー種別 | 閲覧 | 編集 | 削除 |
| --- | --- | --- | --- |
| 管理者 | ◯（全件） | ◯ | ◯ |
| オペレータ | ◯（全件） | ◯ | ◯ |
| パートナー | △（自店舗のみ） | ◯ | ◯ |
| コンシェルジュ | △（自分の案件のみ） | △ | ✕ |

**デバイス対応**:
- コンシェルジュ：スマホ専用（簡略表示）
- その他：PC/レスポンシブ

#### 案件作成・編集
| ユーザー種別 | 実行 |
| --- | --- |
| 管理者 | ◯ |
| オペレータ | ◯ |
| パートナー | ◯ |
| コンシェルジュ | ◯ |

---

### 作業報告画面

#### 作業報告
| ユーザー種別 | 作成 | 下書き保存 |
| --- | --- | --- |
| 管理者 | ✕ | ✕ |
| オペレータ | ✕ | ✕ |
| パートナー | ✕ | ✕ |
| コンシェルジュ | ◯ | ◯ |

**特徴**: スマホ専用、画像アップロード対応、下書き保存機能あり

#### 完了報告一覧
| ユーザー種別 | 閲覧 |
| --- | --- |
| 管理者 | ✕ |
| オペレータ | ✕ |
| パートナー | ✕ |
| コンシェルジュ | ◯ |

---

### 管理者向け画面

#### アカウント管理一覧
| ユーザー種別 | 閲覧 | 作成 | 編集 | 削除 |
| --- | --- | --- | --- | --- |
| 管理者 | ◯ | ◯ | ◯ | ◯ |
| オペレータ | ✕ | ✕ | ✕ | ✕ |
| パートナー | ✕ | ✕ | ✕ | ✕ |
| コンシェルジュ | ✕ | ✕ | ✕ | ✕ |

**特徴**: 自分自身のレコードは三点メニュー非表示

#### アカウント発行
| ユーザー種別 | 実行 |
| --- | --- |
| 管理者 | ◯ |
| オペレータ | ✕ |
| パートナー | ✕ |
| コンシェルジュ | ✕ |

**機能**: 3段階フォーム（種別選択 → 基本情報 → 所属店舗選択）

#### パートナー加盟店一覧
| ユーザー種別 | 閲覧 | 作成 | 編集 | 削除 |
| --- | --- | --- | --- | --- |
| 管理者 | ◯ | ◯ | ◯ | ◯ |
| オペレータ | ✕ | ✕ | ✕ | ✕ |
| パートナー | ✕ | ✕ | ✕ | ✕ |
| コンシェルジュ | ✕ | ✕ | ✕ | ✕ |

#### パートナー加盟店詳細
| ユーザー種別 | 閲覧 | 編集 |
| --- | --- | --- |
| 管理者 | ◯ | ◯ |
| オペレータ | ✕ | ✕ |
| パートナー | ✕ | ✕ |
| コンシェルジュ | ✕ | ✕ |

#### サービス一覧 / サービス詳細 / サービス登録・編集
| ユーザー種別 | 閲覧 | 作成 | 編集 | 削除 |
| --- | --- | --- | --- | --- |
| 管理者 | ◯ | ◯ | ◯ | ◯ |
| オペレータ | ✕ | ✕ | ✕ | ✕ |
| パートナー | ✕ | ✕ | ✕ | ✕ |
| コンシェルジュ | ✕ | ✕ | ✕ | ✕ |

#### サポート種別一覧 / サポート種別登録・編集
| ユーザー種別 | 閲覧 | 作成 | 編集 | 削除 |
| --- | --- | --- | --- | --- |
| 管理者 | ◯ | ◯ | ◯ | ◯ |
| オペレータ | ✕ | ✕ | ✕ | ✕ |
| パートナー | ✕ | ✕ | ✕ | ✕ |
| コンシェルジュ | ✕ | ✕ | ✕ | ✕ |

---

### パートナー加盟店向け画面（未着手）

#### 店舗情報詳細・編集
| ユーザー種別 | 閲覧 | 編集 |
| --- | --- | --- |
| パートナー | ◯（自店舗のみ） | ◯（自店舗のみ） |
| その他 | ✕ | ✕ |

#### コンシェルジュ管理（一覧・詳細・登録・編集）
| ユーザー種別 | 閲覧 | 作成 | 編集 | 削除 |
| --- | --- | --- | --- | --- |
| パートナー | ◯（自店舗のみ） | ◯ | ◯ | ◯ |
| その他 | ✕ | ✕ | ✕ | ✕ |

---

## 4. アクセス制御の実装ガイドライン

### 4.1 データベースレベルでの制御

**パートナー加盟店向け画面**
```sql
WHERE partner_id = current_partner_id
```

**コンシェルジュ向け画面**
```sql
WHERE assigned_concierge_id = current_concierge_id
```

### 4.2 画面表示の制御

- **管理者**: 全機能表示
- **オペレータ**: 顧客・案件管理機能のみ表示
- **パートナー**: 自店舗関連機能のみ表示
- **コンシェルジュ**: 案件・作業報告機能のみ表示（スマホUI）

### 4.3 API レベルでの制御

各APIエンドポイントで、リクエストユーザーの権限を検証し、以下のいずれかを返す：
- **200 OK**: アクセス可能
- **403 Forbidden**: アクセス権限なし
- **404 Not Found**: リソースが見つからない（アクセス権限なし時も同じ）

---

## 5. 権限に関する注意点

### 自分自身の操作制限

- **アカウント管理一覧**: 自分自身のレコードの三点メニューは非表示（削除・編集から保護）

### 論理削除 vs 物理削除

- **ユーザーアカウント**: 論理削除（非アクティブ化）
- **パートナー加盟店**: 論理削除（ステータス変更）
- **案件**: 物理削除（完全削除）

### 権限外のアクション

コンシェルジュが「案件削除」できないのは、現場対応者には削除権を与えるべきではないという設計方針に基づく。オペレータ以上が削除を判断する。

---

## 6. 権限チェックリスト（開発時確認）

- [ ] ログイン画面：未ログイン時のみアクセス可
- [ ] ダッシュボード：ログイン必須、ユーザー種別ごとに異なるUIを表示
- [ ] 顧客管理：自店舗・自分の案件に関連する顧客のみ表示
- [ ] 案件管理：自店舗・自分の案件のみ表示・編集
- [ ] 作業報告：コンシェルジュのみアクセス可
- [ ] 管理画面：管理者のみアクセス可
- [ ] パートナー画面：自店舗情報のみ表示・編集
- [ ] API：リクエストユーザーの権限を検証

---

## 7. 今後の追加検討項目

- [ ] 権限ロールの動的設定機能（管理者が権限をカスタマイズ）
- [ ] 一時的な権限昇格（例：退職予定者の引き継ぎ）
- [ ] 監査ログ（権限操作のトレース）
- [ ] IP制限、デバイス制限
