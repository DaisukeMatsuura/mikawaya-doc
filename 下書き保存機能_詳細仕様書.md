# まごころサポート システム - 下書き保存機能 詳細仕様書

**ドキュメント作成日**: 2026-01-09
**ステータス**: 最終版

---

## 1. 機能概要

### 1.1 目的

ユーザーが長いフォーム（案件作成・編集、作業報告など）を入力中に、意図せずに入力内容を失うことを防ぐ。また、複数回に分けて入力を完了したい場合に対応する。

### 1.2 対象機能

| 画面 | 機能 | API | 備考 |
| --- | --- | --- | --- |
| **案件作成・編集** | 下書き保存・復元 | `POST /api/cases/{id}/draft` | オペレータ・パートナー・コンシェルジュ対象 |
| **作業報告** | 下書き保存・復元 | `POST /api/concierge/cases/{id}/report/draft` | コンシェルジュのみ対象 |

### 1.3 非対象機能

- アカウント発行
- パートナー加盟店登録
- お客様作成・編集
- サービス・サポート種別管理

---

## 2. 機能仕様

### 2.1 下書き保存の動作

#### トリガー

```
「下書き保存」ボタンをクリック
```

#### 処理フロー

```
1. バリデーション実行（必須項目のみチェック）
   ↓
2. サーバーに下書き送信
   ↓
3. サーバー側で下書きを保存
   ↓
4. トースト通知表示「下書きを保存しました」
   ↓
5. フォーム保持（モーダル閉じない、ページ遷移しない）
```

#### バリデーション（下書き保存時）

**ルール**: 必須項目のみチェック、他は無視

| 画面 | 必須項目 |
| --- | --- |
| 案件作成・編集 | 案件No（自動生成の場合）、お客様名 |
| 作業報告 | 案件No、完了日、サポート種別（1つ以上） |

**エラーハンドリング**:
```
- バリデーションエラー → エラーメッセージ表示、保存しない
- ネットワークエラー → 「通信エラーが発生しました。」トースト通知
- サーバーエラー → 「下書き保存に失敗しました。」トースト通知
```

### 2.2 下書き復元の動作

#### 復元のトリガー

```
フォーム画面を開いた時に、下書きが存在する場合
```

#### 復元フロー

```
1. サーバーから下書きデータを取得
   ↓
2. ローカル状態に下書きデータをセット
   ↓
3. フォームフィールドに自動入力
   ↓
4. ユーザーに通知（オプション：「下書きが復元されました」）
```

#### 復元時のトースト通知

**現在の仕様**: 通知なし（自動復元）

**将来の検討**: ユーザーに明示的に復元を確認させるかどうか

---

## 3. データ設計

### 3.1 下書きデータの保存先

| 保存先 | 方式 | メリット | デメリット |
| --- | --- | --- | --- |
| **サーバーDB** | 下書きテーブル | 複数デバイスで同期 | サーバー負荷 |
| **ブラウザ（localStorage）** | JSON | オフライン対応 | デバイス依存、容量制限 |
| **ハイブリッド** | DB + localStorage | 両方のメリット | 実装複雑 |

**採用方式**: **サーバーDB**
- 理由: ユーザーが複数デバイス（PC・スマホ）を使い分ける可能性を考慮

### 3.2 下書きテーブル設計

```sql
CREATE TABLE drafts (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  entity_type VARCHAR(50) NOT NULL,  -- 'case', 'report' など
  entity_id UUID,                    -- 対象ID（案件IDなど）
  data JSONB NOT NULL,               -- フォームデータ全体
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP,              -- 自動削除日時（7日後）
  UNIQUE(user_id, entity_type, entity_id)
);
```

**フィールド詳細**:

| フィールド | 型 | 説明 |
| --- | --- | --- |
| `id` | UUID | 下書きの一意識別子 |
| `user_id` | UUID | 下書きを作成したユーザーID |
| `entity_type` | VARCHAR | 'case'（案件）、'report'（作業報告）など |
| `entity_id` | UUID | 対象エンティティのID（案件ID等）、NULLの場合は新規作成 |
| `data` | JSONB | フォーム入力値全体（JSON形式） |
| `created_at` | TIMESTAMP | 下書き作成日時 |
| `updated_at` | TIMESTAMP | 最終更新日時 |
| `expires_at` | TIMESTAMP | 自動削除日時（デフォルト: created_at + 7日） |

### 3.3 下書きデータのJSON構造（案件作成の例）

```json
{
  "customer_id": "uuid-xxx",
  "customer_name": "田中 太郎",
  "shop_id": "shop-001",
  "service_type": "cleaning",
  "estimated_date": "2026-01-15",
  "estimated_time": "14:00",
  "notes": "玄関と廊下を重点的に...",
  "estimated_price": 15000,
  "concierge_ids": ["con-001", "con-002"],
  "urgency": "normal"
}
```

---

## 4. API 仕様

### 4.1 下書き保存API

**エンドポイント**:
```
POST /api/cases/{caseId}/draft
```

**リクエスト**:
```json
{
  "data": {
    // フォームデータ
  }
}
```

**レスポンス（成功）**:
```json
{
  "status": 200,
  "message": "下書きを保存しました",
  "draft": {
    "id": "draft-uuid",
    "entity_type": "case",
    "entity_id": "case-uuid",
    "updated_at": "2026-01-09T10:30:00Z",
    "expires_at": "2026-01-16T10:30:00Z"
  }
}
```

**レスポンス（エラー）**:
```json
{
  "status": 400,
  "error": "Required field missing",
  "details": ["customer_id", "customer_name"]
}
```

### 4.2 下書き取得API

**エンドポイント**:
```
GET /api/cases/{caseId}/draft
```

**レスポンス（下書き存在）**:
```json
{
  "status": 200,
  "draft": {
    "id": "draft-uuid",
    "entity_type": "case",
    "entity_id": "case-uuid",
    "data": {
      // 下書きデータ
    },
    "updated_at": "2026-01-09T10:30:00Z",
    "expires_at": "2026-01-16T10:30:00Z"
  }
}
```

**レスポンス（下書き未存在）**:
```json
{
  "status": 404,
  "error": "Draft not found"
}
```

### 4.3 下書き削除API

**エンドポイント**:
```
DELETE /api/cases/{caseId}/draft
```

**トリガー**:
- フォーム最終保存時（下書きを削除）
- ユーザー明示削除時

**レスポンス**:
```json
{
  "status": 200,
  "message": "下書きを削除しました"
}
```

---

## 5. フロントエンド実装ガイド

### 5.1 状態管理

**Redux / Zustand でのデータ管理**:

```javascript
// ドラフト状態
{
  draft: {
    isLoading: false,
    data: { /* フォームデータ */ },
    lastSaved: "2026-01-09T10:30:00Z",
    hasUnsavedChanges: true
  }
}
```

### 5.2 自動保存（オプション）

**実装パターン**:
```
- 5秒無操作で自動保存
- または、「下書き保存」ボタン明示クリック
```

**現在の仕様**: 明示的な「下書き保存」ボタンクリックのみ

### 5.3 フォーム初期化時の処理

```javascript
useEffect(() => {
  // 1. 下書きを取得
  const draft = await fetchDraft(caseId);

  // 2. 下書きが存在する場合、フォーム初期化に使用
  if (draft) {
    form.reset(draft.data);
  }
}, [caseId]);
```

### 5.4 保存ボタンのUI

```
[キャンセル] [下書き保存] [保存（完了）]

- キャンセル：モーダル閉じる、入力内容破棄（下書きは保持）
- 下書き保存：サーバーに下書きを送信、フォーム保持
- 保存（完了）：バリデーション → サーバーに送信 → モーダル閉じる、下書き削除
```

---

## 6. ユーザーUX

### 6.1 下書き存在時の表示

**フォーム読み込み時**:
```
「前回の下書きが見つかりました。」（トースト通知または画面内メッセージ）
- フォームに自動入力
- ユーザーは続きから入力可能
```

### 6.2 下書き保存時の確認

```
ユーザーが「下書き保存」をクリック
  ↓
ローディング表示（1〜2秒）
  ↓
「下書きを保存しました」（トースト通知）
  ↓
フォーム保持（继续编辑可能）
```

### 6.3 下書き削除時の動作

```
ユーザーが「保存（完了）」をクリック
  ↓
バリデーション OK
  ↓
サーバーに送信
  ↓
下書きを自動削除
  ↓
モーダル閉じる
  ↓
「○○を作成しました」（トースト通知）
```

---

## 7. エラーハンドリング

### 7.1 下書き保存に失敗した場合

**シナリオ**: ネットワークエラー、サーバーエラー

**処理**:
```
1. トースト通知「下書き保存に失敗しました。接続を確認してからお試しください。」
2. リトライボタンを表示（オプション）
3. ローカルストレージに一時キャッシュ（ブラウザを閉じても保持）
```

### 7.2 下書き復元に失敗した場合

**シナリオ**: 下書きデータが壊れている、サーバーエラー

**処理**:
```
1. 下書き復元をスキップ（空フォームで開始）
2. ログに記録
3. 必要に応じてユーザーに通知
```

### 7.3 下書き有効期限切れ

**有効期限**: 7日間

**期限切れ時の処理**:
```
1. サーバー側で自動削除
2. ユーザーがフォームを開いた時に下書きなし → 空フォームで開始
3. ユーザーに通知なし（自動削除のため）
```

---

## 8. セキュリティ考慮事項

### 8.1 アクセス制御

```
- ユーザーは自分の下書きのみアクセス可能
- 他ユーザーの下書きは 403 Forbidden を返す
```

### 8.2 データ暗号化

```
サーバ側での検討事項:
- HTTPS 通信必須
- DB側での暗号化は不要（サーバーで十分）
```

### 8.3 下書きデータの自動削除

```
有効期限切れ後の自動削除により、古い下書きが蓄積しない
定期的なクリーンアップジョブ（cron）で実装
```

---

## 9. 性能最適化

### 9.1 下書き保存のタイミング

**現在の仕様**: ユーザー明示的なクリック

**将来の最適化案**:
```
- 5秒無操作で自動保存
- 離脱検出（ページ離脱時に自動保存）
```

### 9.2 ネットワーク最適化

```
- 必須項目のみサーバーに送信
- 画像などの大きなデータは下書きに含めない
```

---

## 10. テスト項目

### 10.1 機能テスト

- [ ] 「下書き保存」ボタンをクリックで下書き保存される
- [ ] 下書き保存後、フォーム内容が保持される
- [ ] ページをリロードすると下書きが復元される
- [ ] 「保存（完了）」後、下書きが削除される
- [ ] 複数の下書きが存在する場合、最新のものが復元される

### 10.2 エラーハンドリングテスト

- [ ] ネットワークエラー時、適切なメッセージが表示される
- [ ] サーバーエラー時、リトライ可能な状態になる
- [ ] 必須項目なしで下書き保存しようとしたら、エラーメッセージが表示される

### 10.3 有効期限テスト

- [ ] 7日経過した下書きが自動削除される
- [ ] 期限内の下書きは保持される

### 10.4 セキュリティテスト

- [ ] 他ユーザーの下書きにアクセスできない
- [ ] 削除されたユーザーの下書きは不可視になる

---

## 11. 今後の拡張

### 11.1 自動保存

```
無操作 5秒後に自動保存
サーバーへの負荷考慮が必要
```

### 11.2 下書き一覧画面

```
ユーザーが保存した全下書きを一覧表示
削除・復元を手動で操作可能
```

### 11.3 コラボレーション下書き

```
複数ユーザーが同じフォームを編集する場合、
リアルタイム同期下書き
```

### 11.4 バージョン管理

```
下書きの変更履歴を保持
ユーザーが過去のバージョンに戻すことが可能
```

---

## 12. 実装チェックリスト

### DB側
- [ ] drafts テーブル作成
- [ ] インデックス設定（user_id, entity_type, entity_id）
- [ ] 有効期限切れの自動削除ジョブ実装

### API側
- [ ] POST /api/cases/{caseId}/draft エンドポイント実装
- [ ] GET /api/cases/{caseId}/draft エンドポイント実装
- [ ] DELETE /api/cases/{caseId}/draft エンドポイント実装
- [ ] アクセス制御（ユーザー確認）実装
- [ ] バリデーション実装

### フロントエンド側
- [ ] 下書き保存・復元ロジック実装
- [ ] ボタンUI実装（キャンセル / 下書き保存 / 保存）
- [ ] トースト通知実装
- [ ] ローディング表示実装
- [ ] エラーハンドリング実装

### テスト
- [ ] 機能テスト完了
- [ ] エラーハンドリングテスト完了
- [ ] セキュリティテスト完了
