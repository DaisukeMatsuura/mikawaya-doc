# まごころサポート - 非機能要件定義書

**作成日**: 2026-01-09
**バージョン**: 1.0
**ステータス**: 確定

---

## 📋 目次

1. [パフォーマンス要件](#パフォーマンス要件)
2. [可用性要件](#可用性要件)
3. [スケーラビリティ要件](#スケーラビリティ要件)
4. [保守性要件](#保守性要件)
5. [移行性要件](#移行性要件)
6. [環境要件](#環境要件)

---

## パフォーマンス要件

### レスポンスタイム

| 操作 | 目標値 | 許容最大値 | 備考 |
|------|-------|-----------|------|
| **ページ初期表示** | 2秒以内 | 3秒 | First Contentful Paint |
| **API応答（一覧）** | 500ms以内 | 1秒 | ページネーション込み |
| **API応答（詳細）** | 300ms以内 | 500ms | 単一リソース |
| **API応答（作成/更新）** | 500ms以内 | 1秒 | バリデーション込み |
| **検索（部分一致）** | 1秒以内 | 2秒 | 10万件想定 |
| **ダッシュボード表示** | 2秒以内 | 3秒 | 集計処理込み |
| **ファイルアップロード** | 3秒以内/MB | 5秒/MB | 画像圧縮処理込み |

### スループット

| 項目 | 目標値 | 備考 |
|------|-------|------|
| **同時接続ユーザー数** | 100人 | 通常時 |
| **ピーク時同時接続** | 300人 | 月末・月初 |
| **API リクエスト数** | 1,000 req/min | 通常時 |
| **ピーク時リクエスト** | 3,000 req/min | - |

### リソース使用量

| リソース | 上限目標 | 備考 |
|---------|---------|------|
| **CPU使用率（通常）** | 50%以下 | APIサーバー |
| **CPU使用率（ピーク）** | 80%以下 | スケールアウト閾値 |
| **メモリ使用率** | 70%以下 | - |
| **DB接続数** | 80%以下 | コネクションプール |
| **ディスク使用率** | 70%以下 | アラート閾値 |

### クライアント環境

| 項目 | 要件 |
|------|------|
| **ブラウザ** | Chrome/Edge/Safari/Firefox（最新2バージョン） |
| **モバイル** | iOS 15+、Android 10+ |
| **ネットワーク** | 3G以上（推奨: 4G/WiFi） |
| **画面解像度** | 320px以上（推奨: 375px以上） |

---

## 可用性要件

### 稼働率目標（SLA）

| 環境 | 目標稼働率 | 月間許容ダウンタイム |
|------|-----------|-------------------|
| **本番環境** | 99.5% | 約3.6時間 |
| **ステージング** | 95% | - |
| **開発環境** | 90% | - |

### サービス時間

| 項目 | 時間 |
|------|------|
| **サービス提供時間** | 24時間365日 |
| **計画停止** | 月1回、深夜2:00-4:00（事前通知） |
| **緊急メンテナンス** | 随時（可能な限り事前通知） |

### 障害対応目標

| 項目 | 目標値 |
|------|-------|
| **検知時間（MTTD）** | 5分以内 |
| **応答時間** | 30分以内（営業時間内） |
| **復旧時間（MTTR）** | 2時間以内（Critical） |
| | 4時間以内（High） |
| | 24時間以内（Medium） |

### 冗長化

| レイヤー | 方式 |
|---------|------|
| **アプリケーション** | ECS Fargate（マルチAZ、2台以上） |
| **データベース** | RDS Multi-AZ（自動フェイルオーバー） |
| **キャッシュ** | ElastiCache（レプリカ） |
| **ロードバランサー** | ALB（マルチAZ） |

### バックアップ

| 対象 | 方式 | 頻度 | 保持期間 |
|------|------|------|---------|
| **RDS（DB）** | 自動スナップショット | 日次 | 7日 |
| **RDS（DB）** | 手動スナップショット | 週次 | 30日 |
| **S3（ファイル）** | バージョニング | リアルタイム | 無期限 |
| **設定ファイル** | Git | コミット時 | 無期限 |

### 災害復旧（DR）

| 項目 | 目標値 |
|------|-------|
| **RPO（目標復旧時点）** | 1時間以内 |
| **RTO（目標復旧時間）** | 4時間以内 |
| **DR環境** | 別リージョン（将来検討） |

---

## スケーラビリティ要件

### ユーザー規模想定

| フェーズ | 時期 | パートナー数 | 総ユーザー数 | 月間案件数 |
|---------|------|------------|------------|-----------|
| Phase 1 | 初期 | 10社 | 50人 | 500件 |
| Phase 2 | 6ヶ月後 | 50社 | 300人 | 3,000件 |
| Phase 3 | 1年後 | 100社 | 700人 | 10,000件 |
| Phase 4 | 2年後 | 200社 | 1,500人 | 25,000件 |

### データ量想定

| テーブル | Phase 1 | Phase 4 | 成長率/月 |
|---------|---------|---------|----------|
| users | 50 | 1,500 | +5% |
| customers | 500 | 50,000 | +10% |
| cases | 1,000 | 300,000 | +15% |
| reports | 1,000 | 300,000 | +15% |
| report_photos | 3,000 | 900,000 | +15% |

### スケーリング戦略

#### 水平スケーリング（スケールアウト）

| コンポーネント | トリガー | アクション |
|--------------|---------|-----------|
| ECS Fargate | CPU > 70% | +1タスク（最大10） |
| ECS Fargate | CPU < 30% | -1タスク（最小2） |

#### 垂直スケーリング（スケールアップ）

| コンポーネント | 現在 | Phase 4 目標 |
|--------------|------|-------------|
| RDS | db.t3.medium | db.r5.large |
| ElastiCache | cache.t3.micro | cache.r5.large |
| ECS タスク | 0.5vCPU/1GB | 1vCPU/2GB |

### ボトルネック対策

| ボトルネック | 対策 |
|-------------|------|
| DB読み取り | Read Replica追加、キャッシュ活用 |
| DB書き込み | シャーディング検討（将来） |
| ファイルI/O | S3 Transfer Acceleration |
| API処理 | 非同期処理、キュー導入 |

---

## 保守性要件

### ログ設計

#### ログレベル

| レベル | 用途 | 出力先 |
|-------|------|-------|
| ERROR | エラー・例外 | CloudWatch + Slack通知 |
| WARN | 警告 | CloudWatch |
| INFO | 重要操作 | CloudWatch |
| DEBUG | デバッグ情報 | 開発環境のみ |

#### ログフォーマット

```json
{
  "timestamp": "2026-01-09T12:00:00.000Z",
  "level": "INFO",
  "service": "api",
  "requestId": "req-abc-123",
  "userId": 123,
  "action": "case.create",
  "duration": 245,
  "status": "success",
  "metadata": {}
}
```

#### ログ保持期間

| ログ種別 | 保持期間 |
|---------|---------|
| アプリケーションログ | 90日 |
| アクセスログ | 90日 |
| 監査ログ | 1年 |
| エラーログ | 1年 |

### モニタリング

#### 監視項目

| カテゴリ | 項目 | 閾値 |
|---------|------|------|
| **インフラ** | CPU使用率 | > 80% |
| | メモリ使用率 | > 85% |
| | ディスク使用率 | > 70% |
| **アプリケーション** | エラー率 | > 1% |
| | レスポンスタイム | > 3秒 |
| | 5xxエラー数 | > 10/分 |
| **データベース** | 接続数 | > 80% |
| | クエリ遅延 | > 1秒 |
| **外部連携** | メール送信失敗 | > 5/時 |

#### ダッシュボード

| ダッシュボード | 内容 |
|--------------|------|
| システム概要 | CPU、メモリ、リクエスト数、エラー率 |
| API パフォーマンス | エンドポイント別レスポンスタイム |
| ビジネスメトリクス | 案件数、報告数、ユーザー数 |
| エラー分析 | エラー種別、発生頻度、影響範囲 |

### アラート設計

| 重要度 | 条件 | 通知先 | 対応時間 |
|-------|------|-------|---------|
| Critical | システム停止、データ損失 | PagerDuty + Slack + Email | 即時 |
| High | 一部機能停止、パフォーマンス著しく低下 | Slack + Email | 30分以内 |
| Medium | パフォーマンス低下、警告状態 | Slack | 4時間以内 |
| Low | 情報レベル、改善推奨 | Slack | 次営業日 |

### コード品質

| 指標 | 目標値 |
|------|-------|
| テストカバレッジ（Unit） | 80%以上 |
| テストカバレッジ（E2E） | 主要フロー100% |
| コード複雑度 | Cyclomatic < 10 |
| 重複コード | 5%以下 |
| セキュリティ脆弱性 | Critical: 0 |

---

## 移行性要件

### データ移行

| 項目 | 要件 |
|------|------|
| **移行元** | 既存システム or Excel/CSV |
| **移行方式** | バッチ処理（オフライン） |
| **移行検証** | 件数・整合性チェック |
| **ロールバック** | 移行前スナップショット保持 |

### データ形式

| インポート | エクスポート |
|-----------|-------------|
| CSV（UTF-8） | CSV（UTF-8） |
| Excel（.xlsx） | Excel（.xlsx） |
| JSON | JSON |

### 並行運用

| フェーズ | 期間 | 内容 |
|---------|------|------|
| 準備期 | 2週間 | データ移行、検証 |
| 並行運用期 | 2週間 | 両システム稼働、差分同期 |
| 切替期 | 1日 | 本番切替、旧システム停止 |
| 監視期 | 2週間 | 重点監視、問題対応 |

---

## 環境要件

### 開発環境

| 項目 | 要件 |
|------|------|
| **OS** | macOS / Windows / Linux |
| **Node.js** | 20.x LTS |
| **Docker** | 24.x以上 |
| **IDE** | VSCode（推奨） |
| **Git** | 2.40以上 |

### 開発ツール

| カテゴリ | ツール |
|---------|-------|
| パッケージ管理 | npm / pnpm |
| リンター | ESLint + Prettier |
| テスト | Jest + Playwright |
| API クライアント | Postman / Insomnia |
| DB クライアント | DBeaver / TablePlus |

### CI/CD 環境

| 項目 | ツール |
|------|-------|
| ソースコード管理 | GitHub |
| CI/CD | GitHub Actions |
| コンテナレジストリ | Amazon ECR |
| インフラ管理 | Terraform / AWS CDK |
| シークレット管理 | AWS Secrets Manager |

### 本番環境

| 項目 | 仕様 |
|------|------|
| **クラウド** | AWS（東京リージョン） |
| **コンピュート** | ECS Fargate |
| **データベース** | RDS PostgreSQL 15 |
| **キャッシュ** | ElastiCache Redis 7 |
| **ストレージ** | S3 Standard |
| **CDN** | CloudFront |
| **DNS** | Route 53 |
| **証明書** | ACM |
| **監視** | CloudWatch |
| **ログ** | CloudWatch Logs |

---

## 要件サマリー

### 優先度別要件一覧

| 優先度 | 要件 | 目標値 |
|-------|------|-------|
| 🔴 高 | API応答時間 | 500ms以内 |
| 🔴 高 | 稼働率 | 99.5% |
| 🔴 高 | 障害復旧時間 | 2時間以内 |
| 🔴 高 | バックアップ | 日次 |
| 🟡 中 | 同時接続数 | 100人 |
| 🟡 中 | テストカバレッジ | 80% |
| 🟡 中 | エラー率 | 1%以下 |
| 🟢 低 | RPO | 1時間 |
| 🟢 低 | ログ保持 | 90日 |

---

## チェックリスト

### リリース前チェック

- [ ] パフォーマンステスト実施（負荷テスト）
- [ ] セキュリティテスト実施
- [ ] バックアップ・リストア検証
- [ ] 監視・アラート設定確認
- [ ] ログ出力確認
- [ ] エラーハンドリング確認
- [ ] スケーリング動作確認

### 運用開始後チェック

- [ ] SLA達成状況の確認（月次）
- [ ] パフォーマンス傾向分析（月次）
- [ ] キャパシティプランニング（四半期）
- [ ] 障害レビュー・改善（発生時）
- [ ] コスト最適化レビュー（四半期）

---

**作成者**: Claude Code
**最終更新**: 2026-01-09
