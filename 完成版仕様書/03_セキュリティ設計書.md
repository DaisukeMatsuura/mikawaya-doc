# まごころサポート - セキュリティ設計書

**作成日**: 2026-01-09
**バージョン**: 1.0
**ステータス**: 確定

---

## 📋 目次

1. [セキュリティ方針](#セキュリティ方針)
2. [認証設計](#認証設計)
3. [認可設計](#認可設計)
4. [データ保護](#データ保護)
5. [脆弱性対策](#脆弱性対策)
6. [監査・ログ](#監査ログ)
7. [インシデント対応](#インシデント対応)

---

## セキュリティ方針

### 基本原則

| 原則 | 説明 |
|------|------|
| **最小権限の原則** | ユーザーには業務に必要な最小限の権限のみ付与 |
| **多層防御** | 複数のセキュリティ層で保護 |
| **デフォルト拒否** | 明示的に許可されていないアクセスは拒否 |
| **監査可能性** | すべての重要操作をログに記録 |

### 保護対象データ

| 分類 | データ例 | 保護レベル |
|------|---------|-----------|
| **機密** | パスワード、トークン | 最高（暗号化必須） |
| **個人情報** | 氏名、住所、電話番号、生年月日 | 高（暗号化推奨） |
| **業務データ** | 案件情報、報告内容 | 中（アクセス制御） |
| **公開データ** | サービス一覧、マスタデータ | 低（整合性確保） |

---

## 認証設計

### パスワードポリシー

| 項目 | 要件 |
|------|------|
| **最小文字数** | 8文字以上 |
| **最大文字数** | 128文字以下 |
| **文字種** | 英大文字、英小文字、数字、記号のうち3種以上 |
| **禁止パターン** | メールアドレスと同一、連続文字（aaa, 123） |
| **有効期限** | 90日（設定可能） |
| **履歴チェック** | 過去5回と同一パスワード禁止 |

### パスワード保存

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  パスワードハッシュ化フロー                                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

   平文パスワード
        │
        ▼
   ┌─────────────────┐
   │  バリデーション   │  ← ポリシーチェック
   └────────┬────────┘
            │
            ▼
   ┌─────────────────┐
   │   Salt生成      │  ← ランダム16バイト
   └────────┬────────┘
            │
            ▼
   ┌─────────────────┐
   │  bcrypt ハッシュ │  ← Cost Factor: 12
   └────────┬────────┘
            │
            ▼
   ┌─────────────────┐
   │   DB保存        │  ← $2b$12$xxxxx...
   └─────────────────┘
```

**実装例**:
```javascript
// bcrypt設定
const SALT_ROUNDS = 12;

// ハッシュ化
const hashedPassword = await bcrypt.hash(password, SALT_ROUNDS);

// 検証
const isValid = await bcrypt.compare(inputPassword, hashedPassword);
```

### ログイン試行制限

| 条件 | アクション |
|------|-----------|
| 5回連続失敗 | 15分間ロック |
| 10回連続失敗 | 1時間ロック |
| 20回連続失敗 | アカウント無効化（管理者解除必要） |

### セッション管理

| 項目 | 設定値 |
|------|-------|
| **Access Token有効期限** | 15分 |
| **Refresh Token有効期限** | 7日 |
| **同時セッション数** | 最大3（新規ログインで最古を無効化） |
| **アイドルタイムアウト** | 30分 |
| **絶対タイムアウト** | 8時間 |

### 多要素認証（MFA）【将来対応】

| 方式 | 対象 | 優先度 |
|------|------|-------|
| TOTP（Google Authenticator等） | 管理者 | 高 |
| SMS認証 | 全ユーザー（オプション） | 中 |
| メール認証 | パスワードリセット時 | 実装済み |

---

## 認可設計

### RBAC（Role-Based Access Control）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ロール階層構造                                       │
└─────────────────────────────────────────────────────────────────────────────────┘

                        ┌─────────────┐
                        │   admin     │  全機能アクセス可能
                        └──────┬──────┘
                               │
            ┌──────────────────┼──────────────────┐
            │                  │                  │
            ▼                  ▼                  ▼
     ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
     │  operator   │    │   partner   │    │  concierge  │
     │             │    │             │    │             │
     │ 案件管理    │    │ 自店舗管理   │    │ 担当案件    │
     │ 顧客管理    │    │ 自店舗顧客   │    │ 報告作成    │
     │             │    │ 自店舗案件   │    │             │
     └─────────────┘    └─────────────┘    └─────────────┘
```

### 権限マトリックス

| 機能 | admin | operator | partner | concierge |
|------|-------|----------|---------|-----------|
| **ユーザー管理** |
| アカウント作成 | ◯ | ✕ | ✕ | ✕ |
| アカウント編集 | ◯ | ✕ | ✕ | ✕ |
| アカウント削除 | ◯ | ✕ | ✕ | ✕ |
| **パートナー管理** |
| 全店舗閲覧 | ◯ | ✕ | ✕ | ✕ |
| 店舗登録 | ◯ | ✕ | ✕ | ✕ |
| 自店舗編集 | ◯ | ✕ | ◯ | ✕ |
| **コンシェルジュ管理** |
| 全員閲覧 | ◯ | ✕ | ✕ | ✕ |
| 自店舗閲覧 | ◯ | ✕ | ◯ | ✕ |
| 登録・編集 | ✕ | ✕ | ◯ | ✕ |
| **顧客管理** |
| 全顧客閲覧 | ◯ | ◯ | ✕ | ✕ |
| 自店舗顧客閲覧 | ◯ | ◯ | ◯ | △ |
| 顧客登録 | ✕ | ◯ | ◯ | ◯ |
| **案件管理** |
| 全案件閲覧 | ◯ | ◯ | ✕ | ✕ |
| 自店舗案件閲覧 | ◯ | ◯ | ◯ | △ |
| 案件作成 | ✕ | ◯ | ◯ | ◯ |
| 案件編集 | ✕ | ◯ | ◯ | △ |
| **報告管理** |
| 報告閲覧 | ◯ | ◯ | ◯ | △ |
| 報告作成 | ✕ | ✕ | ✕ | ◯ |
| **マスタ管理** |
| サービス管理 | ◯ | ✕ | ✕ | ✕ |
| 種別管理 | ◯ | ✕ | ✕ | ✕ |

**凡例**: ◯=フルアクセス / △=自分に関連するもののみ / ✕=アクセス不可

### リソースレベル制御

```typescript
// パートナーは自店舗のデータのみアクセス可能
if (user.userType === 'partner') {
  query.where('partner_id', user.partnerId);
}

// コンシェルジュは担当案件のみアクセス可能
if (user.userType === 'concierge') {
  query.whereIn('id', user.assignedCaseIds);
}
```

### APIエンドポイント保護

```typescript
// ミドルウェア構成
app.use('/api/admin/*', authMiddleware, requireRole('admin'));
app.use('/api/operator/*', authMiddleware, requireRole('operator', 'admin'));
app.use('/api/partner/*', authMiddleware, requireRole('partner'), partnerScopeMiddleware);
app.use('/api/concierge/*', authMiddleware, requireRole('concierge'), conciergeScopeMiddleware);
```

---

## データ保護

### 暗号化

#### 保存時暗号化（At Rest）

| 対象 | 方式 | 備考 |
|------|------|------|
| データベース | AWS RDS 暗号化（AES-256） | 透過的暗号化 |
| S3 | SSE-S3（AES-256） | 自動暗号化 |
| バックアップ | 暗号化スナップショット | RDS標準機能 |

#### 通信時暗号化（In Transit）

| 経路 | 方式 | 備考 |
|------|------|------|
| クライアント ↔ ALB | TLS 1.3 | 証明書: ACM |
| ALB ↔ ECS | TLS 1.2+ | 内部通信 |
| ECS ↔ RDS | TLS 1.2+ | SSL接続必須 |

#### アプリケーションレベル暗号化

```typescript
// 機密データの追加暗号化（必要に応じて）
import crypto from 'crypto';

const ENCRYPTION_KEY = process.env.ENCRYPTION_KEY; // 32バイト
const IV_LENGTH = 16;

function encrypt(text: string): string {
  const iv = crypto.randomBytes(IV_LENGTH);
  const cipher = crypto.createCipheriv('aes-256-cbc', ENCRYPTION_KEY, iv);
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  return iv.toString('hex') + ':' + encrypted;
}

function decrypt(encryptedText: string): string {
  const [ivHex, encrypted] = encryptedText.split(':');
  const iv = Buffer.from(ivHex, 'hex');
  const decipher = crypto.createDecipheriv('aes-256-cbc', ENCRYPTION_KEY, iv);
  let decrypted = decipher.update(encrypted, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  return decrypted;
}
```

### 個人情報の取り扱い

#### 個人情報項目一覧

| テーブル | カラム | 分類 | 取り扱い |
|---------|-------|------|---------|
| users | email | 個人情報 | ログ出力時マスク |
| customers | name_sei, name_mei | 個人情報 | - |
| customers | phone | 個人情報 | - |
| customers | address | 個人情報 | - |
| customers | birth_date | 個人情報 | 年齢計算のみ使用 |
| customers | emergency_contact_* | 個人情報 | - |
| concierges | すべて | 個人情報 | - |

#### マスキング処理

```typescript
// ログ出力時のマスキング
function maskEmail(email: string): string {
  const [local, domain] = email.split('@');
  return local.substring(0, 2) + '***@' + domain;
  // example@example.com → ex***@example.com
}

function maskPhone(phone: string): string {
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1-****-$2');
  // 09012345678 → 090-****-5678
}
```

### データ保持・削除ポリシー

| データ種別 | 保持期間 | 削除方法 |
|-----------|---------|---------|
| アクティブデータ | 無期限 | - |
| 退会ユーザー | 1年 | 論理削除→物理削除 |
| 完了案件 | 5年 | アーカイブ→削除 |
| 作業報告 | 5年 | アーカイブ→削除 |
| ログデータ | 1年 | 自動削除 |
| 下書きデータ | 30日 | 自動削除 |

---

## 脆弱性対策

### OWASP Top 10 対応

#### 1. インジェクション対策

```typescript
// SQLインジェクション対策: パラメータ化クエリ
// NG
const query = `SELECT * FROM users WHERE email = '${email}'`;

// OK (Prisma)
const user = await prisma.user.findUnique({
  where: { email: email }
});

// OK (raw query)
const users = await prisma.$queryRaw`
  SELECT * FROM users WHERE email = ${email}
`;
```

#### 2. 認証の不備対策

- パスワードポリシー強制
- ログイン試行制限
- セッション管理の厳格化
- 安全なパスワードリセットフロー

#### 3. 機密データの露出対策

```typescript
// レスポンスから機密データを除外
const userResponse = {
  id: user.id,
  email: user.email,
  name: user.name,
  userType: user.userType,
  // password_hash は含めない
  // created_at, updated_at は必要に応じて
};
```

#### 4. XXE対策

- XMLパーサーの外部エンティティ無効化
- JSONを優先使用

#### 5. アクセス制御の不備対策

```typescript
// オブジェクトレベルの権限チェック
async function getCase(caseId: number, user: User) {
  const case = await prisma.case.findUnique({
    where: { id: caseId }
  });

  if (!case) {
    throw new NotFoundError();
  }

  // パートナーは自店舗の案件のみ
  if (user.userType === 'partner' && case.partnerId !== user.partnerId) {
    throw new ForbiddenError();
  }

  return case;
}
```

#### 6. セキュリティ設定ミス対策

```typescript
// Helmet.js でセキュリティヘッダー設定
import helmet from 'helmet';

app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
    },
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
  },
}));
```

#### 7. XSS対策

```typescript
// 入力サニタイズ
import DOMPurify from 'isomorphic-dompurify';

function sanitizeInput(input: string): string {
  return DOMPurify.sanitize(input, {
    ALLOWED_TAGS: [], // HTMLタグを全て除去
  });
}

// React では自動エスケープ（dangerouslySetInnerHTML を避ける）
```

#### 8. 安全でないデシリアライゼーション対策

- JSONのみ使用
- 入力データの厳格なバリデーション

#### 9. 既知の脆弱性コンポーネント対策

```bash
# 定期的な依存関係チェック
npm audit
npm audit fix

# Dependabot / Snyk の導入
```

#### 10. 不十分なログ・監視対策

- 後述の監査ログセクション参照

### CSRF対策

```typescript
// CSRF トークン生成・検証
import csrf from 'csurf';

// Cookie ベースの CSRF 保護
app.use(csrf({ cookie: true }));

// API リクエストでトークン検証
app.post('/api/*', (req, res, next) => {
  // X-CSRF-Token ヘッダーを検証
  next();
});
```

### レート制限

```typescript
import rateLimit from 'express-rate-limit';

// API 全体のレート制限
const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分
  max: 100, // 100リクエスト
  message: 'リクエスト数が上限を超えました。しばらく待ってからお試しください。'
});

// ログインエンドポイントの厳格な制限
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  message: 'ログイン試行回数が上限を超えました。'
});

app.use('/api/', apiLimiter);
app.use('/api/auth/login', loginLimiter);
```

---

## 監査・ログ

### 監査ログ対象イベント

| カテゴリ | イベント | ログレベル |
|---------|---------|-----------|
| **認証** | ログイン成功 | INFO |
| | ログイン失敗 | WARN |
| | ログアウト | INFO |
| | パスワード変更 | INFO |
| | パスワードリセット要求 | INFO |
| **認可** | 権限エラー（403） | WARN |
| | 不正アクセス試行 | ERROR |
| **データ操作** | ユーザー作成 | INFO |
| | ユーザー削除 | INFO |
| | 案件作成 | INFO |
| | 案件削除 | INFO |
| | 報告提出 | INFO |
| **システム** | アプリケーション起動 | INFO |
| | エラー発生 | ERROR |
| | 外部API呼び出し | DEBUG |

### ログフォーマット

```json
{
  "timestamp": "2026-01-09T12:00:00.000Z",
  "level": "INFO",
  "event": "LOGIN_SUCCESS",
  "userId": 123,
  "userType": "partner",
  "ip": "192.168.1.100",
  "userAgent": "Mozilla/5.0...",
  "requestId": "req-abc-123",
  "details": {
    "email": "us***@example.com"
  }
}
```

### ログ保存

| ログ種別 | 保存先 | 保持期間 |
|---------|-------|---------|
| アプリケーションログ | CloudWatch Logs | 90日 |
| 監査ログ | CloudWatch Logs + S3 | 1年 |
| アクセスログ | ALB + S3 | 90日 |
| エラーログ | CloudWatch Logs | 90日 |

---

## インシデント対応

### セキュリティインシデント分類

| レベル | 説明 | 例 |
|-------|------|-----|
| **Critical** | 重大な被害が発生 | データ漏洩、不正アクセス |
| **High** | 重大な被害の可能性 | 脆弱性発見、不審なアクセス急増 |
| **Medium** | 限定的な影響 | 一部機能の障害 |
| **Low** | 軽微な影響 | 単発のエラー |

### 対応フロー

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           インシデント対応フロー                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   検知       │───>│   判断       │───>│   対応       │───>│   報告       │
│              │    │              │    │              │    │              │
│ - 監視アラート │    │ - レベル判定  │    │ - 封じ込め   │    │ - 内部報告   │
│ - ユーザー報告│    │ - 影響範囲   │    │ - 原因調査   │    │ - 外部通知   │
│ - 定期チェック│    │ - 緊急度     │    │ - 復旧       │    │ - 記録       │
└──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
                                                                    │
                                                                    ▼
                                                           ┌──────────────┐
                                                           │   改善       │
                                                           │              │
                                                           │ - 再発防止   │
                                                           │ - プロセス改善│
                                                           └──────────────┘
```

### 連絡先

| 役割 | 連絡先 | 対応時間 |
|------|-------|---------|
| セキュリティ担当 | security@example.com | 24時間 |
| 開発チームリード | dev-lead@example.com | 営業時間 |
| インフラ担当 | infra@example.com | 24時間 |

---

## チェックリスト

### 開発時チェック

- [ ] パスワードポリシーの実装
- [ ] 入力バリデーションの実装
- [ ] SQLインジェクション対策
- [ ] XSS対策
- [ ] CSRF対策
- [ ] 認証・認可の実装
- [ ] エラーメッセージの適切な処理
- [ ] 機密情報のログ出力防止

### デプロイ前チェック

- [ ] 依存関係の脆弱性チェック（npm audit）
- [ ] セキュリティヘッダーの設定
- [ ] TLS設定の確認
- [ ] 環境変数の適切な管理
- [ ] 本番環境でのデバッグモード無効化

### 定期チェック

- [ ] 依存関係の更新（月1回）
- [ ] アクセスログの確認（週1回）
- [ ] 権限設定の見直し（四半期）
- [ ] セキュリティ教育（年1回）

---

**作成者**: Claude Code
**最終更新**: 2026-01-09
