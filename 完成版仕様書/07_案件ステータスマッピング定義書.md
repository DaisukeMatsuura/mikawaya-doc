# まごころサポート - 案件ステータスマッピング定義書

**作成日**: 2026-01-09
**バージョン**: 1.0
**ステータス**: 確定

---

## 📋 目次

1. [概要](#概要)
2. [DBステータスと表示ステータスの関係](#dbステータスと表示ステータスの関係)
3. [ユーザー種別ごとの表示ステータス一覧](#ユーザー種別ごとの表示ステータス一覧)
4. [状態条件マトリックス](#状態条件マトリックス)
5. [シナリオ別ステータス表示例](#シナリオ別ステータス表示例)
6. [フローチャート](#フローチャート)

---

## 概要

案件（Case）は、システム内部では統一されたDB ステータス値を持つが、ユーザー種別（オペレータ・パートナー・コンシェルジュ）によって**異なる表示名（ラベル）**で表示される。これは各ユーザーの業務視点に合わせた表現を行うためである。

### 設計方針

1. **DB ステータス**: システム内部で一意に管理する値（英語）
2. **表示ステータス**: ユーザーに見せる日本語ラベル（ユーザー種別ごとに異なる）
3. **可視性ルール**: ユーザー種別・担当状況により、案件自体が表示されない場合がある

---

## DBステータスと表示ステータスの関係

### DB ステータス値（8種類）

| DB値 | 意味 | 説明 |
|------|------|------|
| `draft` | 下書き | 案件が下書き状態（未確定） |
| `pending` | 確認待ち | 案件が作成され、確認待ち状態 |
| `confirmed` | 確定 | 案件内容が確定、店舗決定待ち |
| `assigned` | アサイン済 | コンシェルジュがアサインされた |
| `in_progress` | 対応中 | コンシェルジュが作業を開始 |
| `completed` | 作業完了 | 作業は完了、報告未提出 |
| `reported` | 報告済み | 作業報告が提出された |
| `cancelled` | キャンセル | 案件がキャンセルされた |

---

## ユーザー種別ごとの表示ステータス一覧

### オペレータ向け表示ステータス

| DB ステータス | 追加条件 | 表示ステータス | バッジ色 | 説明 |
|--------------|---------|---------------|---------|------|
| `draft` | - | 下書き | グレー | オペレータが下書き保存した案件 |
| `pending` | - | オペレーター確認中 | 黄色 | オペレータが確認中の案件 |
| `confirmed` | 店舗未決定 | 店舗未決定 | オレンジ | 確定したが担当店舗が未決定 |
| `confirmed` | 店舗決定済 | 店舗未対応 | オレンジ | 店舗は決まったがパートナー未確認 |
| `assigned` | CS未決定 | CS確認中 | 水色 | パートナーがコンシェルジュ選定中 |
| `assigned` | CS決定済 | 対応予定 | 水色 | コンシェルジュがアサイン済 |
| `in_progress` | - | 対応中 | 青 | コンシェルジュが作業中 |
| `completed` | - | 報告未完了 | 紫 | 作業完了、報告待ち |
| `reported` | - | 報告完了 | 緑 | 作業報告が提出済み |
| `cancelled` | - | キャンセル | 赤 | キャンセルされた案件 |

---

### パートナー向け表示ステータス

| DB ステータス | 追加条件 | 表示ステータス | バッジ色 | 説明 |
|--------------|---------|---------------|---------|------|
| `draft` | - | （非表示） | - | パートナーには表示されない |
| `pending` | - | 店舗未確認 | オレンジ | オペレータからの新規案件（未確認） |
| `confirmed` | - | 確認済み | 水色 | パートナーが確認済み |
| `assigned` | CS未確定 | CS未決定 | 黄色 | コンシェルジュを選定する必要あり |
| `assigned` | CS確定済 | 訪問予定 | 水色 | コンシェルジュがアサイン済み |
| `in_progress` | - | 対応中 | 青 | コンシェルジュが作業中 |
| `completed` | - | 報告待ち | 紫 | 作業完了、報告提出待ち |
| `reported` | - | 完了 | 緑 | 全て完了 |
| `cancelled` | - | キャンセル | 赤 | キャンセルされた案件 |

---

### コンシェルジュ向け表示ステータス

| DB ステータス | 追加条件 | 表示ステータス | バッジ色 | 説明 |
|--------------|---------|---------------|---------|------|
| `draft` | - | （非表示） | - | 自分が担当でないため非表示 |
| `pending` | - | （非表示） | - | 自分が担当でないため非表示 |
| `confirmed` | - | （非表示） | - | 自分が担当でないため非表示 |
| `assigned` | 自分が担当 & 訪問日未定 | 訪問日が未決 | 黄色 | 訪問予定日を入力する必要あり |
| `assigned` | 自分が担当 & 訪問日確定 | 訪問予定 | 水色 | 訪問予定が決まっている |
| `in_progress` | 自分が担当 | 対応中 | 青 | 現在作業中の案件 |
| `completed` | 自分が担当 | 未報告 | オレンジ | 作業完了、報告を提出する必要あり |
| `reported` | 自分が担当 | 報告済み | 緑 | 報告提出完了 |
| `cancelled` | - | （非表示） | - | キャンセル案件は非表示 |

**重要**: コンシェルジュは**自分が担当としてアサインされた案件のみ**表示される。

---

## 状態条件マトリックス

### 同じ案件が各ユーザーにどう見えるか

| 案件の状態（条件） | オペレータ表示 | パートナー表示 | コンシェルジュ表示 |
|------------------|---------------|---------------|-------------------|
| 下書き状態 | 下書き | （非表示） | （非表示） |
| 作成直後（店舗未決定） | 店舗未決定 | （非表示） | （非表示） |
| 店舗決定、パートナー未確認 | 店舗未対応 | 店舗未確認 | （非表示） |
| パートナー確認済、CS未決定 | CS確認中 | CS未決定 | （非表示） |
| CS決定、訪問日未定 | 対応予定 | 訪問予定 | 訪問日が未決 |
| CS決定、訪問日確定 | 対応予定 | 訪問予定 | 訪問予定 |
| 作業開始済み | 対応中 | 対応中 | 対応中 |
| 作業完了、報告未提出 | 報告未完了 | 報告待ち | 未報告 |
| 報告提出済み | 報告完了 | 完了 | 報告済み |
| キャンセル | キャンセル | キャンセル | （非表示） |

---

## シナリオ別ステータス表示例

### シナリオ1: 新規案件作成から店舗決定まで

```
【状況】オペレータが新規案件を作成し、担当店舗を決定

Step 1: オペレータが案件を下書き保存
  - オペレータ: 「下書き」
  - パートナー: 非表示
  - コンシェルジュ: 非表示

Step 2: オペレータが案件を確定（店舗未選択）
  - オペレータ: 「店舗未決定」
  - パートナー: 非表示
  - コンシェルジュ: 非表示

Step 3: オペレータが担当店舗を決定
  - オペレータ: 「店舗未対応」
  - パートナー: 「店舗未確認」（新着として表示）
  - コンシェルジュ: 非表示
```

### シナリオ2: パートナー確認からコンシェルジュアサインまで

```
【状況】パートナーが案件を確認し、コンシェルジュをアサイン

Step 4: パートナーが案件を確認
  - オペレータ: 「CS確認中」
  - パートナー: 「CS未決定」
  - コンシェルジュ: 非表示

Step 5: パートナーがコンシェルジュをアサイン（訪問日未定）
  - オペレータ: 「対応予定」
  - パートナー: 「訪問予定」
  - コンシェルジュ: 「訪問日が未決」（自分の案件として表示開始）

Step 6: コンシェルジュが訪問予定日を入力
  - オペレータ: 「対応予定」
  - パートナー: 「訪問予定」
  - コンシェルジュ: 「訪問予定」
```

### シナリオ3: 作業実施から報告完了まで

```
【状況】コンシェルジュが作業を実施し、報告を提出

Step 7: コンシェルジュが作業を開始
  - オペレータ: 「対応中」
  - パートナー: 「対応中」
  - コンシェルジュ: 「対応中」

Step 8: コンシェルジュが作業を完了
  - オペレータ: 「報告未完了」
  - パートナー: 「報告待ち」
  - コンシェルジュ: 「未報告」

Step 9: コンシェルジュが報告を提出
  - オペレータ: 「報告完了」
  - パートナー: 「完了」
  - コンシェルジュ: 「報告済み」
```

---

## フローチャート

### 案件ライフサイクルと各ユーザーの可視性

```
                                    【オペレータ】    【パートナー】   【コンシェルジュ】
                                         │               │                │
┌─────────────────┐                       │               │                │
│     draft       │                   下書き           非表示            非表示
│    （下書き）    │                       │               │                │
└────────┬────────┘                       │               │                │
         │ 案件確定                        │               │                │
         ▼                                │               │                │
┌─────────────────┐                       │               │                │
│    pending      │                 店舗未決定          非表示            非表示
│  （確認待ち）    │                       │               │                │
└────────┬────────┘                       │               │                │
         │ 店舗決定                        │               │                │
         ▼                                │               │                │
┌─────────────────┐                       │               │                │
│   confirmed     │                 店舗未対応        店舗未確認          非表示
│    （確定）      │                       │               │                │
└────────┬────────┘                       │               │                │
         │ パートナー確認                  │               │                │
         ▼                                │               │                │
┌─────────────────┐                       │               │                │
│   assigned      │                  CS確認中         CS未決定           非表示
│ （CS未アサイン） │                       │               │                │
└────────┬────────┘                       │               │                │
         │ CSアサイン                      │               │                │
         ▼                                │               │                │
┌─────────────────┐                       │               │                │
│   assigned      │                  対応予定          訪問予定    訪問日が未決/訪問予定
│ （CSアサイン済） │                       │               │          ★表示開始
└────────┬────────┘                       │               │                │
         │ 作業開始                        │               │                │
         ▼                                │               │                │
┌─────────────────┐                       │               │                │
│  in_progress    │                   対応中           対応中            対応中
│   （対応中）     │                       │               │                │
└────────┬────────┘                       │               │                │
         │ 作業完了                        │               │                │
         ▼                                │               │                │
┌─────────────────┐                       │               │                │
│   completed     │                 報告未完了         報告待ち          未報告
│  （作業完了）    │                       │               │                │
└────────┬────────┘                       │               │                │
         │ 報告提出                        │               │                │
         ▼                                │               │                │
┌─────────────────┐                       │               │                │
│    reported     │                  報告完了           完了           報告済み
│   （報告済み）   │                       │               │                │
└─────────────────┘                       │               │                │
```

---

## ステータスバッジ色の統一ルール

| 色 | 意味 | 使用シーン |
|----|------|----------|
| グレー | 未確定/下書き | draft状態 |
| オレンジ | 要対応/警告 | 未確認、未報告など次のアクションが必要 |
| 黄色 | 確認中/検討中 | 誰かが確認・検討中の状態 |
| 水色 | 進行中/予定 | アサイン済み、訪問予定など |
| 青 | 対応中 | 現在作業が進行中 |
| 紫 | 完了待ち | 作業は終わったが報告待ち |
| 緑 | 完了 | 全て完了した状態 |
| 赤 | キャンセル/エラー | キャンセルやエラー状態 |

---

## 実装時の考慮事項

### 1. ステータス変換ロジック

```
// 擬似コード
function getDisplayStatus(dbStatus, userRole, caseData) {
  switch (userRole) {
    case 'operator':
      return getOperatorStatus(dbStatus, caseData);
    case 'partner':
      return getPartnerStatus(dbStatus, caseData);
    case 'concierge':
      return getConciergeStatus(dbStatus, caseData);
  }
}
```

### 2. 可視性チェック

```
// コンシェルジュの場合
function isVisibleToConcierge(case, userId) {
  return case.conciergeId === userId
         && case.status !== 'cancelled'
         && ['assigned', 'in_progress', 'completed', 'reported'].includes(case.status);
}
```

### 3. 追加条件の判定

| 条件 | 判定方法 |
|------|---------|
| 店舗未決定 | `partnerId === null` |
| CS未決定 | `conciergeId === null` |
| 訪問日未定 | `visitDate === null` |
| 自分が担当 | `conciergeId === currentUserId` |

---

## 関連ドキュメント

- [04_画面遷移図.md](04_画面遷移図.md) - 案件ステータス遷移図
- [01_データベース設計書.md](01_データベース設計書.md) - cases テーブル定義
- [画面仕様書/04_案件管理/](画面仕様書/04_案件管理/) - 各ユーザー向け案件一覧画面

---

**作成者**: Claude Code
**最終更新**: 2026-01-09
